server {
    listen 80;
    server_name _;

    # Healthcheck root
    location = / {
        return 200 'Package Management Gateway â€” OK';
        add_header Content-Type text/plain;
    }

    # Authentication subrequest endpoint (internal)
    location = /_auth {
        internal;
        content_by_lua_block {
            local auth = require "auth"
            local cjson = require "cjson.safe"

            local ok, res = auth.validate_token(ngx)
            if not ok then
                ngx.status = res.status or 401
                ngx.say(res.body or cjson.encode({ error = "Unauthorized" }))
                return ngx.exit(ngx.status)
            end

            ngx.req.set_header("X-User-Id", res.user_id)

            if res.new_token then
                ngx.req.set_header("X-New-Auth-Token", res.new_token)
            end
        }
    }

    # Auth service endpoints (public access for login/register)
    location /api/auth/ {
        proxy_pass http://auth-service:8000/api/auth/;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    }

    # Global /api/ block: common headers & rate limiting
    location /api/ {
        limit_req zone=ip_req_zone burst=20 nodelay;

        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header Host $host;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_pass_request_body on;

        # fallback if no other /api/ endpoint matches
        return 502 "No upstream matched";
    }

    # Public endpoint: /api/main/ptc
    location /api/main/ptc/ {
        proxy_pass http://main-service:6500/ptc/;
    }

    # Protected endpoint: /api/main/prv
    location /api/main/prv/ {
        auth_request /_auth;
        proxy_pass http://main-service:6500/prv/;
    }
}