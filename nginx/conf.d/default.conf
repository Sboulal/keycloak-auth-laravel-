server {
    listen 80;
    server_name _;

    location = / {
        return 200 'Package Management Gateway â€” OK';
        add_header Content-Type text/plain;
    }

    location = /_auth {
        internal;
        content_by_lua_block {
            local auth = require "custom.auth"
            local cjson = require "cjson.safe"

            ngx.log(ngx.INFO, "Auth check started for: ", ngx.var.request_uri)

            local valid, result = auth.validate_token(ngx)
            
            if not valid then
                ngx.log(ngx.WARN, "Auth validation failed: ", cjson.encode(result or {}))
                ngx.status = result.status or 401
                ngx.header.content_type = 'application/json'
                ngx.say(result.body or cjson.encode({ error = "Unauthorized" }))
                return ngx.exit(ngx.status)
            end

            ngx.log(ngx.INFO, "Auth successful for user: ", result.user_id or "unknown")
            ngx.var.auth_user_id = result.user_id or ""
            ngx.var.auth_new_token = result.new_token or ""
        }
    }

    location /api/auth/ {
        proxy_pass http://auth-service:8000/api/auth/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/main/prv/ {
        set $auth_user_id "";
        set $auth_new_token "";

        auth_request /_auth;

        proxy_pass http://main-service:6500/prv/;
        proxy_set_header X-User-Id $auth_user_id;
        proxy_set_header X-New-Token $auth_new_token;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}