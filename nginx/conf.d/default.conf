server {
    listen 80;
    server_name _;

    location = / {
        return 200 'Package Management Gateway â€” OK';
        add_header Content-Type text/plain;
    }

    location = /_auth {
    internal;
    content_by_lua_block {
        local auth = require "custom.auth"
        local cjson = require "cjson.safe"

        ngx.log(ngx.INFO, "Auth check started for: ", ngx.var.request_uri)

        local ok, res = pcall(auth.validate_token, ngx)
        
        if not ok then
            -- Lua error occurred
            ngx.log(ngx.ERR, "Auth validation crashed: ", tostring(res))
            ngx.status = 500
            ngx.header.content_type = 'application/json'
            ngx.say(cjson.encode({ error = "Internal authentication error" }))
            return ngx.exit(500)
        end

        local valid, result = res[1], res[2]
        
        if not valid then
            ngx.log(ngx.WARN, "Auth validation failed: ", cjson.encode(result))
            ngx.status = result.status or 401
            ngx.header.content_type = 'application/json'
            ngx.say(result.body or cjson.encode({ error = "Unauthorized" }))
            return ngx.exit(ngx.status)
        end

        ngx.log(ngx.INFO, "Auth successful for user: ", result.user_id)
        ngx.var.auth_user_id = result.user_id or ""
        ngx.var.auth_new_token = result.new_token or ""
    }
}
    location /api/auth/ {
        proxy_pass http://auth-service:8000/api/auth/;
    }

    location /api/main/prv/ {
        set $auth_user_id "";
        set $auth_new_token "";

        auth_request /_auth;

        proxy_pass http://main-service:6500/prv/;
        proxy_set_header X-User-Id $auth_user_id;
        proxy_set_header X-New-Token $auth_new_token;
    }
}
